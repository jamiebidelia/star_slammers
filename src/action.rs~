extern crate pancurses;
use crate::creature;
use crate::direction;
use crate::tile_map;
use crate::console;

pub enum Action
{
    MoveUp,
    MoveDown,
    MoveLeft,
    MoveRight,
    Pass,
    Invalid,
    Resize,
    EndGame
}

pub fn do_action(game_action    : &Action,
                 game_window    : &pancurses::Window,
                 game_map       : &tile_map::TileMap,
                 actor          : &mut creature::Creature,
                 end_game       : &mut bool,
                 mut console_buffer : &mut Vec<String>)
{
    
    match game_action
    {
        Action::MoveUp    => make_move(actor, direction::Direction::North, &game_map, &game_window, &mut console_buffer),
        Action::MoveDown  => make_move(actor, direction::Direction::South, &game_map, &game_window, &mut console_buffer),
        Action::MoveLeft  => make_move(actor, direction::Direction::East,  &game_map, &game_window,  &mut console_buffer),
        Action::MoveRight => make_move(actor, direction::Direction::West,  &game_map, &game_window,  &mut console_buffer),
        Action::Pass      =>
        {
            let message = format!("{}:  Pass.", actor.get_name());
            console::post_to_console(message,
                                     &game_window,
                                     &mut console_buffer)
        },
        Action::Invalid   => (),
        Action::Resize    => {game_window.clear();},
        Action::EndGame   => *end_game = true,
    }
}

fn make_move(actor          : &mut creature::Creature,
             direction      : direction::Direction,
             game_map       : &tile_map::TileMap,
             game_window    : &pancurses::Window,
             mut console_buffer : &mut Vec<String>)
{

    // Grab the x index of the actor.
    let actor_x_index = actor.get_x_pos();
    let actor_x_index = *actor_x_index as usize;

    // Grab the y index of the actor.
    let actor_y_index = actor.get_y_pos();
    let actor_y_index = *actor_y_index as usize;

    let map = game_map.get_map();

    
    match direction
    {
        direction::Direction::North =>
            if (actor_y_index < (*game_map.get_y_size() - 1) as usize) && // Remember that if y_size is 10, the max tile is tile 9.
               (*map[actor_x_index][actor_y_index + 1].get_passable() == true)

            {
                actor.set_y_pos(actor.get_y_pos() + 1);
            }
           else
           {
               let message = format!("{}:  Cannot Go North!", actor.get_name());
               console::post_to_console(message, &game_window, &mut console_buffer);
           },
        direction::Direction::South =>
            if (actor_y_index > 0) &&
               (*map[actor_x_index][actor_y_index - 1].get_passable() == true)
            {
                actor.set_y_pos(actor.get_y_pos() - 1);
            }
            else
            {
                let message = format!("{}:  Cannot Go South!", actor.get_name());
                console::post_to_console(message, &game_window, &mut console_buffer);
            },
        direction::Direction::East =>
            if (actor_x_index > 0) &&
               (*map[actor_x_index - 1][actor_y_index].get_passable() == true)
            {
                actor.set_x_pos(actor.get_x_pos() - 1);
            }
            else
            {  
                let message = format!("{}:  Cannot Go East!", actor.get_name());
                console::post_to_console(message, &game_window, &mut console_buffer);
            },
        direction::Direction::West =>
            if (actor_x_index < (*game_map.get_x_size() - 1) as usize) && // Remember that if x_size is 10, the max tile is tile 9.
               (*map[actor_x_index + 1][actor_y_index].get_passable() == true)
            {
                actor.set_x_pos(actor.get_x_pos() + 1);
            }
            else
            {
                let message = format!("{}:  Cannot Go West!", actor.get_name());
                console::post_to_console(message, &game_window, &mut console_buffer);
            }
    } // End match direction.
}
